apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "deliver.fullname" . }}
  labels:
{{ include "deliver.labels" . | indent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "deliver.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "deliver.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      containers:
      - name: git-sync
        image: "{{ .Values.gitSync.image.repository }}:{{ .Values.gitSync.image.tag }}"
        args:
        - "-ssh={{ .Values.gitSync.git.sshEnabled }}"
        - "-repo={{ .Values.gitSync.git.repository }}"
        - "-dest=git-sync"
        - "-branch={{ .Values.gitSync.git.branch }}"
        - "-depth=1"
        imagePullPolicy: {{ .Values.gitSync.image.pullPolicy }}
        securityContext:
          runAsUser: 65533
        volumeMounts:
        - name: shared
          mountPath: /tmp/git
        - name: git-secret
          mountPath: /etc/git-secret
      - name: cicd
        image: "{{ .Values.cicd.image.repository }}:{{ .Values.cicd.image.tag }}"
        imagePullPolicy: {{ .Values.cicd.image.pullPolicy }}
        command:
        - /bin/sh
        - -ec
        - |
          alias k="kubectl --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          sleep 5
          while :
          do
            CURRENT=$(basename -- /shared/rev*) && sleep 5 && NEW=$(basename -- /shared/rev*)
            if [ $CURRENT != $NEW ]; then
              echo "New delivery"
              k delete -f /shared/pipeline-job.yaml --grace-period=0 --force > /dev/null 2>&1 || true
              k apply -f /shared/pipeline-job.yaml
              CURRENT=$NEW
            fi
          done
        volumeMounts:
        - name: shared
          mountPath: /shared
        - name: pipelinejob-configmap
          mountPath: /shared/pipeline-job.yaml
          subPath: pipeline-job.yaml
      volumes:
      - name: shared
        emptyDir: {}
      - name: pipelinejob-configmap
        configMap:
          name: {{ .Release.Name }}-pipelinejob-configmap 
      - name: git-secret
        secret:
          secretName: git-secret
          defaultMode: 288
